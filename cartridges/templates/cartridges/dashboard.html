{% extends 'base.html' %}

{% block title %}Дашборд - Учёт расходников{% endblock %}

{% block content %}
{% csrf_token %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Дашборд</h1>
</div>

<!-- Общая статистика -->
<div class="row mb-4">
    <div class="col-md-2 mb-3">
        <div class="card text-white bg-dark stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">{{ stats.total_consumables }}</h5>
                        <p class="card-text">Всего расходников</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-boxes fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card text-white bg-primary stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">{{ stats.total_cartridges }}</h5>
                        <p class="card-text">Картриджей</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-tint fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card text-white bg-info stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">{{ stats.total_drums }}</h5>
                        <p class="card-text">Барабанов</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-success stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">{{ stats.cartridges_in_stock }}</h5>
                        <p class="card-text">Картриджей на складе</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-warehouse fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-success stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">{{ stats.drums_in_stock }}</h5>
                        <p class="card-text">Барабанов на складе</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-warehouse fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Последние операции -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Последние операции</h5>
            </div>
            <div class="card-body">
                {% if recent_operations %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Тип</th>
                                <th>Расходник</th>
                                <th>Тип</th>
                                <th>Локация</th>
                                <th>Пользователь</th>
                                <th>Дата</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for operation in recent_operations %}
                            <tr>
                                <td>
                                    <span class="badge 
                                        {% if operation.operation_type == 'receipt' %}bg-success
                                        {% elif operation.operation_type == 'install' %}bg-primary
                                        {% elif operation.operation_type == 'issue_service' %}bg-warning
                                        {% elif operation.operation_type == 'dispose' %}bg-danger
                                        {% else %}bg-secondary{% endif %}">
                                        {{ operation.get_operation_type_display }}
                                    </span>
                                </td>
                                <td>
                                    <a href="{% url 'cartridges:cartridge_detail' operation.cartridge.pk %}">
                                        {{ operation.cartridge.serial_number }}
                                    </a>
                                </td>
                                <td>
                                    <span class="badge {% if operation.cartridge.consumable_type == 'drum' %}bg-info{% else %}bg-primary{% endif %}">
                                        {{ operation.cartridge.get_consumable_type_display }}
                                    </span>
                                </td>
                                <td>{{ operation.to_location.name }}</td>
                                <td>{{ operation.user.username }}</td>
                                <td>{{ operation.timestamp|date:"d.m.Y H:i" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">Нет операций</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Требуют внимания -->
<div class="col-md-4">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h5 class="card-title mb-0">Требуют внимания</h5>
                <small class="text-muted">Картриджи, требующие ремонта или с превышением заправок</small>
            </div>
            <div class="btn-group" role="group">
                <button class="btn btn-sm btn-outline-danger" 
                        id="bulk-service-btn"
                        title="Отправить все картриджи, требующие ремонта, на заправку">
                    <i class="fas fa-tools"></i>
                </button>
                <button class="btn btn-sm btn-outline-success" 
                        id="bulk-return-btn"
                        title="Вернуть все картриджи с заправки на склад">
                    <i class="fas fa-warehouse"></i>
                </button>
                <span class="badge bg-danger ms-2">{{ attention_consumables.count }}</span>
                <a href="{% url 'cartridges:print_attention_report' %}" 
                    class="btn btn-sm btn-outline-primary"
                    title="Распечатать отчёт"
                    target="_blank">
                        <i class="fas fa-print"></i>
                </a>
                 <span class="badge bg-danger ms-2">{{ attention_consumables.count }}</span>
              
            </div>
        </div>
        <div class="card-body">
            {% if attention_consumables %}
            <div class="d-flex justify-content-between mb-3">
                <div>
                    <span class="badge bg-danger">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Требуют ремонта: {{ needs_repair_count }}
                    </span>
                    <span class="badge bg-warning ms-2">
                        <i class="fas fa-refresh me-1"></i>
                        Превышен лимит: {{ max_refills_count }}
                    </span>
                </div>
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Кликните на состояние для изменения
                </small>
            </div>
            
            <div class="list-group list-group-flush" id="attention-list">
                {% for consumable in attention_consumables %}
                <div class="list-group-item {% if consumable.condition == 'needs_repair' %}border-start border-3 border-danger{% endif %}">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">
                            {% if consumable.condition == 'needs_repair' %}
                            <i class="fas fa-exclamation-circle text-danger me-1"></i>
                            {% endif %}
                            {{ consumable.serial_number }}
                        </h6>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                    type="button" 
                                    data-bs-toggle="dropdown" 
                                    aria-expanded="false"
                                    data-cartridge-id="{{ consumable.pk }}">
                                <span class="badge 
                                    {% if consumable.condition == 'new' %}bg-success
                                    {% elif consumable.condition == 'working' %}bg-primary
                                    {% elif consumable.condition == 'refilled' %}bg-info
                                    {% else %}bg-warning{% endif %}"
                                    id="badge-{{ consumable.pk }}">
                                    {{ consumable.get_condition_display }}
                                </span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><h6 class="dropdown-header">Изменить состояние:</h6></li>
                                <li>
                                    <a class="dropdown-item condition-change" 
                                       href="#" 
                                       data-condition="new"
                                       data-cartridge-id="{{ consumable.pk }}">
                                        <span class="badge bg-success me-2">Новый</span>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item condition-change" 
                                       href="#" 
                                       data-condition="working"
                                       data-cartridge-id="{{ consumable.pk }}">
                                        <span class="badge bg-primary me-2">Рабочий</span>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item condition-change" 
                                       href="#" 
                                       data-condition="refilled"
                                       data-cartridge-id="{{ consumable.pk }}">
                                        <span class="badge bg-info me-2">Заправлен</span>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item condition-change" 
                                       href="#" 
                                       data-condition="needs_repair"
                                       data-cartridge-id="{{ consumable.pk }}">
                                        <span class="badge bg-warning me-2">Требует ремонта</span>
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-danger send-to-service-btn" 
                                       href="#"
                                       data-cartridge-id="{{ consumable.pk }}">
                                        <i class="fas fa-tools me-2"></i>Отправить на заправку
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" 
                                       href="{% url 'cartridges:cartridge_detail' consumable.pk %}">
                                        <i class="fas fa-eye me-2"></i>Подробнее
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <p class="mb-1 small">
                        <span class="badge {% if consumable.consumable_type == 'drum' %}bg-info{% else %}bg-primary{% endif %} me-1">
                            {{ consumable.get_consumable_type_display }}
                        </span>
                        {{ consumable.model }}
                    </p>
                    <small class="text-muted d-flex justify-content-between">
                        <span>
                            {% if consumable.condition == 'needs_repair' %}
                            <span class="badge bg-danger">
                                <i class="fas fa-wrench me-1"></i>Требует ремонта
                            </span>
                            {% else %}
                            <span class="badge bg-warning">
                                <i class="fas fa-refresh me-1"></i>Заправок: {{ consumable.refill_count }}/{{ consumable.model.max_refills }}
                            </span>
                            {% endif %}
                        </span>
                        <div>
                            <a href="{% url 'cartridges:operation_create_for_cartridge' consumable.pk %}" 
                               class="text-decoration-none me-2"
                               title="Создать операцию">
                                <i class="fas fa-exchange-alt"></i>
                            </a>
                        </div>
                    </small>
                </div>
                {% endfor %}
            </div>
            
            {% if attention_consumables.count > 10 %}
            <div class="mt-3 text-center">
                <a href="{% url 'cartridges:cartridge_list' %}?condition=needs_repair" 
                   class="btn btn-sm btn-outline-danger me-2">
                    <i class="fas fa-wrench me-1"></i>Все требующие ремонта
                </a>
                <a href="{% url 'cartridges:cartridge_list' %}?needs_attention=1" 
                   class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-list me-1"></i>Все требующие внимания
                </a>
            </div>
            {% endif %}
            
            {% else %}
            <p class="text-muted">
                <i class="fas fa-check-circle text-success me-2"></i>
                Нет расходников, требующих внимания
            </p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}

<script>// Массовая отправка на заправку
document.getElementById('bulk-service-btn').addEventListener('click', function() {
    if (!confirm('Отправить ВСЕ картриджи, требующие ремонта, на заправку?\n\nЭта операция изменит их статус на "На заправке" и создаст операции перемещения.')) {
        return;
    }
    
    const button = this;
    const originalHtml = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    fetch('/cartridges/bulk-send-to-service/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', data.message);
            
            // Обновляем статистику
            if (data.count > 0) {
                setTimeout(() => {
                    location.reload(); // Перезагружаем страницу для обновления данных
                }, 2000);
            }
        } else {
            showNotification('error', data.error || 'Ошибка при отправке на заправку');
            button.innerHTML = originalHtml;
            button.disabled = false;
        }
    })
    .catch(error => {
        showNotification('error', 'Ошибка сети');
        console.error('Error:', error);
        button.innerHTML = originalHtml;
        button.disabled = false;
    });
});

// Отправка одного картриджа на заправку
document.querySelectorAll('.send-to-service-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const cartridgeId = this.getAttribute('data-cartridge-id');
        
        if (!confirm('Отправить этот картридж на заправку?\n\nСтатус будет изменен на "На заправке".')) {
            return;
        }
        
        const dropdown = this.closest('.dropdown');
        const button = dropdown.querySelector('.dropdown-toggle');
        const badge = dropdown.querySelector('.badge');
        
        const originalBadge = badge.innerHTML;
        badge.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        fetch(`/cartridges/${cartridgeId}/send-to-service/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('success', data.message);
                // Закрываем dropdown и обновляем страницу через 1 секунду
                const bsDropdown = bootstrap.Dropdown.getInstance(button);
                if (bsDropdown) {
                    bsDropdown.hide();
                }
                setTimeout(() => location.reload(), 1000);
            } else {
                badge.innerHTML = originalBadge;
                showNotification('error', data.error || 'Ошибка при отправке');
            }
        })
        .catch(error => {
            badge.innerHTML = originalBadge;
            showNotification('error', 'Ошибка сети');
            console.error('Error:', error);
        });
    });
});</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработчик изменения состояния
    document.querySelectorAll('.condition-change').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            
            const cartridgeId = this.getAttribute('data-cartridge-id');
            const newCondition = this.getAttribute('data-condition');
            const button = this.closest('.dropdown').querySelector('.dropdown-toggle');
            const badge = document.getElementById(`badge-${cartridgeId}`);
            
            // Показываем индикатор загрузки
            const originalBadge = badge.innerHTML;
            badge.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            // Отправляем AJAX запрос
            fetch(`/cartridges/${cartridgeId}/update-condition/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: `condition=${newCondition}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Обновляем бейдж
                    badge.innerHTML = data.condition_display;
                    badge.className = `badge ${data.badge_class}`;
                    
                    // Показываем уведомление
                    showNotification('success', data.message);
                    
                    // Закрываем dropdown
                    const dropdown = bootstrap.Dropdown.getInstance(button);
                    if (dropdown) {
                        dropdown.hide();
                    }
                } else {
                    badge.innerHTML = originalBadge;
                    showNotification('error', data.error || 'Ошибка при обновлении');
                }
            })
            .catch(error => {
                badge.innerHTML = originalBadge;
                showNotification('error', 'Ошибка сети');
                console.error('Error:', error);
            });
        });
    });
    
    // Функция для получения CSRF токена
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Функция для показа уведомлений
    function showNotification(type, message) {
        // Создаем уведомление
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
        alertDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Автоматически скрываем через 3 секунды
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }
});

// Стили для анимации
const style = document.createElement('style');
style.textContent = `
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}
.badge-updated {
    animation: pulse 0.5s ease-in-out;
}
.alert {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
`;
document.head.appendChild(style);

// Массовый возврат с заправки на склад - ФИНАЛЬНАЯ ИСПРАВЛЕННАЯ ВЕРСИЯ
const bulkReturnBtn = document.getElementById('bulk-return-btn');
if (bulkReturnBtn) {
    bulkReturnBtn.addEventListener('click', async function() {
        console.log('=== НАЧАЛО ОБРАБОТКИ КНОПКИ ВОЗВРАТА ===');
        
        // 1. ВАЖНО: Используем токен ИЗ КУКИ, а не из поля формы
        const csrfToken = getCookie('csrftoken');
        
        console.log('CSRF из куки:', csrfToken?.substring(0, 10) + '...');
        console.log('CSRF из поля:', document.querySelector('[name=csrfmiddlewaretoken]')?.value?.substring(0, 10) + '...');
        
        if (!csrfToken) {
            alert('❌ Ошибка: CSRF токен не найден в куки. Перезагрузите страницу.');
            return;
        }
        
        // 2. Подтверждение действия
        if (!confirm('Вернуть ВСЕ картриджи со статусом "На заправке" обратно на склад?\n\nСтатус: "На складе"\nСостояние: "Заправлен"')) {
            return;
        }
        
        // 3. Показываем индикатор загрузки
        const button = this;
        const originalHtml = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;
        
        try {
            console.log('Отправка запроса на сервер...');
            
            // 4. Отправляем запрос с правильным CSRF
            const response = await fetch('/cartridges/bulk-return-from-service/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,  // ← Токен из куки!
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    action: 'return_from_service',
                    timestamp: new Date().toISOString()
                })
            });
            
            console.log('Статус ответа:', response.status, response.statusText);
            
            // 5. Проверяем ответ
            if (response.status === 403) {
                throw new Error('Ошибка доступа (403). CSRF токен не совпадает.');
            }
            
            if (!response.ok) {
                throw new Error(`HTTP ошибка: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('Ответ сервера:', data);
            
            // 6. Обрабатываем результат
            if (data.success) {
                alert(`✅ ${data.message}\n\nВозвращено: ${data.count} картриджей`);
                
                // Обновляем страницу через 2 секунды
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                throw new Error(data.error || data.message || 'Неизвестная ошибка сервера');
            }
            
        } catch (error) {
            console.error('Ошибка при выполнении запроса:', error);
            alert('❌ Ошибка: ' + error.message);
            
            // Восстанавливаем кнопку
            button.innerHTML = originalHtml;
            button.disabled = false;
        }
    });
}

// Функция получения куки (уже есть, но убедитесь что она работает)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}