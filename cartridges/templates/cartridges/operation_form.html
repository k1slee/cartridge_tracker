{% extends 'base.html' %}

{% block title %}Создание операции - Учёт картриджей{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        {% if cartridge %}
            Операция с картриджем {{ cartridge.serial_number }}
        {% else %}
            Создание операции
        {% endif %}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        {% if cartridge %}
        <a href="{% url 'cartridges:cartridge_detail' cartridge.pk %}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Назад к картриджу
        {% else %}
        <a href="{% url 'cartridges:cartridge_list' %}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Назад к списку
        {% endif %}
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Данные операции</h5>
            </div>
            <div class="card-body">
                <form method="post" id="operation-form">
                    {% csrf_token %}
                    
                    {% for field in form %}
                    <div class="mb-3">
                        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                        {{ field }}
                        {% if field.help_text %}
                        <div class="form-text">{{ field.help_text }}</div>
                        {% endif %}
                        {% for error in field.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                    
                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>Создать операцию
                        </button>
                        {% if cartridge %}
                        <a href="{% url 'cartridges:cartridge_detail' cartridge.pk %}" class="btn btn-secondary">Отмена</a>
                        {% else %}
                        <a href="{% url 'cartridges:cartridge_list' %}" class="btn btn-secondary">Отмена</a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Типы операций</h5>
            </div>
            <div class="card-body">
                <h6>Поступление</h6>
                <p class="small text-muted">Добавление нового картриджа в систему</p>
                
                <h6>Выдача на заправку</h6>
                <p class="small text-muted">Передача картриджа в сервисный центр</p>
                
                <h6>Приём с заправки</h6>
                <p class="small text-muted">Возврат картриджа после обслуживания</p>
                
                <h6>Установка в принтер</h6>
                <p class="small text-muted">Монтаж картриджа в конкретный принтер</p>
                
                <h6>Снятие с принтера</h6>
                <p class="small text-muted">Демонтаж картриджа из принтера</p>
                
                <h6>Перемещение</h6>
                <p class="small text-muted">Перемещение между локациями</p>
                
                <h6>Списание</h6>
                <p class="small text-muted">Вывод картриджа из эксплуатации</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const inputs = document.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        if (!input.classList.contains('form-control') && input.type !== 'checkbox') {
            input.classList.add('form-control');
        }
    });
    
    const operationTypeSelect = document.getElementById('id_operation_type');
    const toLocationSelect = document.getElementById('id_to_location');
    const printerSelect = document.getElementById('id_printer');
    
    // Функция для загрузки принтеров по локации
    function loadPrintersByLocation(locationId) {
        if (!locationId) {
            printerSelect.innerHTML = '<option value="">---------</option>';
            return;
        }
        
        fetch(`/api/printers-by-location/?location_id=${locationId}`)
            .then(response => response.json())
            .then(data => {
                printerSelect.innerHTML = '<option value="">---------</option>';
                data.printers.forEach(printer => {
                    const option = document.createElement('option');
                    option.value = printer.id;
                    option.textContent = printer.name;
                    printerSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading printers:', error);
            });
    }
    
    // Функция для загрузки локаций по типу операции
    function loadLocationsByOperationType(operationType) {
        if (!operationType) {
            return;
        }
        
        fetch(`/api/locations-by-operation/?operation_type=${operationType}`)
            .then(response => response.json())
            .then(data => {
                const currentValue = toLocationSelect.value;
                toLocationSelect.innerHTML = '<option value="">---------</option>';
                data.locations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location.id;
                    option.textContent = location.name;
                    toLocationSelect.appendChild(option);
                });
                
                // Восстанавливаем выбранное значение, если оно есть в новых опциях
                if (currentValue) {
                    toLocationSelect.value = currentValue;
                }
            })
            .catch(error => {
                console.error('Error loading locations:', error);
            });
    }
    
    // Обработчик изменения типа операции
    if (operationTypeSelect) {
        operationTypeSelect.addEventListener('change', function() {
            const operationType = this.value;
            
            if (operationType === 'install') {
                // Для установки загружаем локации с принтерами
                loadLocationsByOperationType('install');
            } else {
                // Для других операций показываем все локации
                loadLocationsByOperationType('other');
            }
        });
    }
    
    // Обработчик изменения локации "куда"
    if (toLocationSelect) {
        toLocationSelect.addEventListener('change', function() {
            const locationId = this.value;
            loadPrintersByLocation(locationId);
        });
    }
    
    // Инициализация при загрузке страницы
    if (operationTypeSelect && operationTypeSelect.value === 'install') {
        loadLocationsByOperationType('install');
    }
    
    // Если уже выбрана локация, загружаем принтеры
    if (toLocationSelect && toLocationSelect.value) {
        loadPrintersByLocation(toLocationSelect.value);
    }
});
</script>
{% endblock %}